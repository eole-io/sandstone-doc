<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Full example of websocket application working with a RestApi</title>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
        <link rel="stylesheet" href="/sandstone/css/bootstrap4-sandstone.min.css">
        <link rel="stylesheet" href="/sandstone/css/prism.css">
        <link rel="stylesheet" href="/sandstone/css/all.css">
    </head>
    <body>
        <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="/sandstone/">Sandstone</a>

    <a
        href="https://github.com/eole-io/sandstone"
        class="github-button"
        aria-label="Star eole-io/sandstone on GitHub"
        data-count-aria-label="# stargazers on GitHub"
        data-count-api="/repos/eole-io/sandstone#stargazers_count"
        data-count-href="/eole-io/sandstone/stargazers"
        data-style="mega"
    >Star Sandstone</a>
</nav>


<div class="container-fluid">
    <div class="row">
        <div class="col-sm-3">
            <div class="sticky-nav">
                <nav class="nav-left">
    <h3 class="no-margin-top">Sandstone</h2>

    <ul class="nav flex-column">
        <li class="nav-item 
">
            <a href="/sandstone/get-started" class="nav-link text-muted">
                <i class="fa fa-home" aria-hidden="true"></i>
                Get started
                <br>
                <span>Introduction + Basic usage</span>
            </a>
        </li>
        <li class="nav-item active
">
            <a href="/sandstone/examples/full" class="nav-link text-muted">
                <i class="fa fa-code" aria-hidden="true"></i>
                Example: Full app
                <br>
                <span>RestApi + Websocket + Push</span>
            </a>
        </li>
        <li class="nav-item 
">
            <a href="/sandstone/examples/multichannel-chat" class="nav-link text-muted">
                <i class="fa fa-code" aria-hidden="true"></i>
                Example: Chat server
                <br>
                <span>Websocket</span>
            </a>
        </li>
        <li class="nav-item 
">
            <a href="/sandstone/authentication" class="nav-link text-muted">
                <i class="fa fa-user" aria-hidden="true"></i>
                Authentication
                <br>
                <span>Rest API + websocket connections</span>
            </a>
        </li>
        <li class="nav-item 
">
            <a href="/sandstone/topic-route-parameters" class="nav-link text-muted">
                <i class="fa fa-sitemap" aria-hidden="true"></i>
                Topic route parameters
                <br>
                <span>Retrieve topic route arguments</span>
            </a>
        </li>
        <li class="nav-item 
">
            <a href="/sandstone/websocket-events" class="nav-link text-muted">
                <i class="fa fa-wifi" aria-hidden="true"></i>
                Listen websocket events
                <br>
                <span>onOpen, onClose, onPublish...</span>
            </a>
        </li>
        <li class="nav-item 
">
            <a href="/sandstone/push-debug-profiler" class="nav-link text-muted">
                <i class="fa fa-list-alt" aria-hidden="true"></i>
                Push debug profiler
                <br>
                <span>Enable that awesome debug tool !</span>
            </a>
        </li>
        <li class="nav-item 
">
            <a href="/sandstone/big-picture" class="nav-link text-muted">
                <i class="fa fa-picture-o" aria-hidden="true"></i>
                Big picture
                <br>
                <span>Sandstone full schema</span>
            </a>
        </li>
        <li class="nav-item 
">
            <a href="/sandstone/under-the-hood" class="nav-link text-muted">
                <i class="fa fa-cogs" aria-hidden="true"></i>
                Under the hood
                <br>
                <span>Used libraries</span>
            </a>
        </li>
        <li class="nav-item 
">
            <a href="/sandstone/install-zmq-php-linux" class="nav-link text-muted">
                <i class="fa fa-archive" aria-hidden="true"></i>
                ZMQ Linux installation
                <br>
                <span>and php binding</span>
            </a>
        </li>
    </ul>

    <h3>Sandstone Edition</h2>


    <ul class="nav flex-column">
        <li class="nav-item 
">
            <a href="/sandstone/edition/get-started" class="nav-link text-muted">
                <i class="fa fa-home" aria-hidden="true"></i>
                Get started
                <br>
                <span>Introduction + Installation</span>
            </a>
        </li>
        <li class="nav-item 
">
            <a href="/sandstone/edition/cookbook" class="nav-link text-muted">
                <i class="fa fa-home" aria-hidden="true"></i>
                Cookbook
                <br>
                <span>Usage + API + Real time</span>
            </a>
        </li>
    </ul>

    <h3>Community</h2>
</nav>

            </div>
        </div>
        <main class="col-sm-9 col-lg-6">
            <h1 class="no-margin-top">Full example</h1>

<p>Example of a fully working rest api working together with a websocket server.</p>

<p>
    <b>Note</b>: there is a Docker image for this example.
    Check <a href="https://bitbucket.org/zareba_pawel/php-websockets-sandstone">zareba_pawel/php-websockets-sandstone</a>.
</p>


<h2>Use case</h2>

<p>
    We want a rest api endpoint to post articles,
    and a multichannel chat where we can talk,
    and be notified when an article is published.
</p>

<p>How to do it with Sandstone:</p>

<p>
    <b>Rest Api stack</b>:
    A rest api will allow to POST articles
    by calling <code>POST rest-api.php/api/articles</code>,
    then the rest api will respond with a http status CREATED.
    <br />

    <b>Websocket stack</b>:
    In a same way, a multichannel chat server in mounted
    by running <code>php websocket-server.php</code>,
    we can enter and publish message to channels (i.e <code>channel/general</code>).
    <br />

    <b>Push server</b>:
    When someone will publish an article using rest api,
    an event will be sent to websocket server thread using Push server,
    and this event will be publish to all chat channels
    to notice chat users that an article has just been published.
</p>


<h2>Installation</h2>

Create your composer.json:

<p class="file">
    <i class="fa fa-file-code-o" aria-hidden="true"></i>
    composer.json
</p>

<pre><code class="language-json">{
    "require": {
        "eole/sandstone": "2.0.x"
    },
    "autoload": {
        "psr-4": {
            "": "src/"
        }
    }
}
</code></pre>


Then run <code>composer update</code>.


<h2>Project structure</h2>

<pre>Silex\Application</pre>

<p class="text-center">
    <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
</p>


<pre>Eole\Sandstone\Application</pre>

<p class="text-center">
    <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
</p>


<p class="file">
    <i class="fa fa-file-code-o" aria-hidden="true"></i>
    src/MyApp.php
</p>

<pre><code class="language-php">class MyApp extends Eole\Sandstone\Application
{
    public function __construct()
    {
        parent::__construct([
            'debug' => true,
        ]);

        // Sandstone requires JMS serializer
        $this->register(new Eole\Sandstone\Serializer\ServiceProvider());

        // Register and configure your websocket server
        $this->register(new Eole\Sandstone\Websocket\ServiceProvider(), [
            'sandstone.websocket.server' => [
                'bind' => '0.0.0.0',
                'port' => '25569',
            ],
        ]);

        // Register Push Server and ZMQ bridge extension
        $this->register(new \Eole\Sandstone\Push\ServiceProvider());
        $this->register(new \Eole\Sandstone\Push\Bridge\ZMQ\ServiceProvider(), [
            'sandstone.push.server' => [
                'bind' => '127.0.0.1',
                'host' => '127.0.0.1',
                'port' => 5555,
            ],
        ]);

        // Register serializer metadata
        $this['serializer.builder']->addMetadataDir(
            __DIR__,
            ''
        );
    }
}
</code></pre>


<div class="row">
    <div class="col-sm-6">
        <div class="hidden-xs">
            <p class="text-center">
    <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
</p>

        </div>

        <p class="file">
    <i class="fa fa-file-code-o" aria-hidden="true"></i>
    rest-api.php
</p>

        <pre><code class="language-php">require_once 'vendor/autoload.php';

use Symfony\Component\HttpFoundation\JsonResponse;

$app = new MyApp();

// Creating an api endpoint at POST api/articles
$app->post('api/articles', function () use ($app) {
    // Persisting article...
    $articleId = 42;

    $event = new ArticleEvent();

    $event->id = $articleId;
    $event->title = 'Unicorns spotted in Alaska';
    $event->url = 'http://unicorn.com/articles/unicorns-spotted-alaska';

    // Dispatch an event on article creation
    $app['dispatcher']->dispatch('article.created', $event);

    return new JsonResponse($articleId, 201);
});

// Send all 'article.created' events to push server
$app->forwardEventToPushServer('article.created');

$app->run();
</code></pre>

    </div>
    <div class="col-sm-6">
        <div class="hidden-xs">
            <p class="text-center">
    <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
</p>

        </div>

        <p class="file">
    <i class="fa fa-file-code-o" aria-hidden="true"></i>
    websocket-server.php
</p>

        <pre><code class="language-php">require_once 'vendor/autoload.php';

$app = new MyApp();

// Add a route `chat/{channel}` and its Topic factory (works same as mounting API endpoints)
$app->topic('chat/{channel}', function ($topicPattern) {
    return new ChatTopic($topicPattern);
});

// Encapsulate your application and start websocket server
$websocketServer = new Eole\Sandstone\Websocket\Server($app);

$websocketServer->run();
</code></pre>

    </div>
</div>


<h2>Implement ChatTopic class</h2>

<p>
    In this example, we used a <code>ChatTopic</code> class.
</p>
<p>
    In our case, we want:
</p>
<ul>
    <li>
        <code>ChatTopic</code> just broadcast all incoming chat messages to every subscribers,
    </li>
    <li>
        broadcast a message when an article has been posted.
    </li>
</ul>
<p>
    So we need to listen to <code>article.created</code> event:
    <br>
    The topic class has to implement <code>Symfony\Component\EventDispatcher\EventSubscriberInterface</code>
    to automatically listen to events (to be used with <code>forwardEventToPushServer</code>).
</p>
<p>
    So let's implement <code>ChatTopic</code> class:
</p>

<p class="file">
    <i class="fa fa-file-code-o" aria-hidden="true"></i>
    src/ChatTopic.php
</p>

<pre><code class="language-php">use Symfony\Component\EventDispatcher\EventSubscriberInterface;

class ChatTopic extends Eole\Sandstone\Websocket\Topic implements EventSubscriberInterface
{
    /**
     * Broadcast message to each subscribing client.
     *
     * {@InheritDoc}
     */
    public function onPublish(Ratchet\Wamp\WampConnection $conn, $topic, $event)
    {
        $this->broadcast([
            'type' => 'message',
            'message' => $event,
        ]);
    }

    /**
     * Subscribe to article.created event.
     *
     * {@InheritDoc}
     */
    public static function getSubscribedEvents()
    {
        return [
            'article.created' => 'onArticleCreated',
        ];
    }

    /**
     * Article created listener.
     *
     * @param ArticleEvent $event
     */
    public function onArticleCreated(ArticleEvent $event)
    {
        $this->broadcast([
            'type' => 'article_created',
            'message' => 'An article has just been published: '.$event->title.', read it here: '.$event->url,
        ]);
    }
}
</code></pre>



<h2>About serialization</h2>

<p>
    When an object is sent to websocket server from rest api stack,
    or is sent by rest api response to http client,
    Sandstone uses JMS serializer to serialize it at one side,
    and deserialize at the other side.
</p>

<p>
    In this example, an instance of <code>ArticleEvent</code> is sent to websocket server.
</p>

<p>
    So this is how the class and its serializer metadata look like:
</p>

<div class="row">
    <div class="col-sm-6">
        <p class="file">
    <i class="fa fa-file-code-o" aria-hidden="true"></i>
    src/ArticleEvent.php
</p>

        <pre><code class="language-php">use Symfony\Component\EventDispatcher\Event;

class ArticleEvent extends Event
{
    /**
     * @var int
     */
    public $id;

    /**
     * @var string
     */
    public $title;

    /**
     * @var string
     */
    public $url;
}
</code></pre>

    </div>
    <div class="col-sm-6">
        <p class="file">
    <i class="fa fa-file-code-o" aria-hidden="true"></i>
    src/ArticleEvent.yml
</p>

        <pre><code class="language-yaml">ArticleEvent:
    exclusion_policy: NONE
    properties:
        id:
            type: integer
        title:
            type: string
        url:
            type: string
</code></pre>


        <p>
            That's why we needed to add in <code>MyApp</code>:
        </p>

        <p class="file">
    <i class="fa fa-file-code-o" aria-hidden="true"></i>
    src/MyApp.php
</p>


        <figure class="highlight"><pre><code class="language-php" data-lang="php">// Register serializer metadata
$this['serializer.builder']-&gt;addMetadataDir(
    __DIR__,
    ''
);</code></pre></figure>
    </div>
</div>


<h2>Now, let's run the thing</h2>

<div class="row">
    <div class="col-sm-6">
        <p>The rest api endpoint will be hit with:</p>
        <pre class="command-line" data-prompt="$" data-output="2-200"><code class="language-bash">POST rest-api.php/api/articles

HTTP/1.1 201 Created
Content-Length: 2
Content-Type: application/json

42</code></pre>
    </div>
    <div class="col-sm-6">
        <p>Run the websocket server and push server with:</p>
        <pre class="command-line" data-prompt="$" data-output="2-200"><code class="language-bash">php websocket-server.php

# Websocket server is starting
[info] Initialization... []
[info] Bind websocket server {"bind":"0.0.0.0","port":"25569"}
[info] Bind push server {"bind":"127.0.0.1","host":"127.0.0.1","port":5555}

# Someone connects to websocket server
[info] Connection event {"event":"open"}
[info] Authentication... []
[info] Anonymous connection []

# the connected guy subscribes to a chat topic
[info] Topic event {"event":"subscribe","topic":"chat/general"}

# Websocket server received an event from rest api
[info] Push message event {"event":"article.created"}</code></pre>
    </div>
</div>

        </main>
    </div>
</div>


        <footer>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-6 offset-md-3 text-center">
                <p>Sandstone is under <a href="https://github.com/eole-io/sandstone/blob/master/LICENSE">MIT license</a>.</p>
                <br />

                <ul class="list-unstyled">
                    <li>
                        <i class="fa fa-github fa-lg" aria-hidden="true"></i>
                        <a href="https://github.com/eole-io/sandstone">Sandstone</a>
                    </li>
                    <li>
                        <i class="fa fa-github fa-lg" aria-hidden="true"></i>
                        <a href="https://github.com/eole-io/sandstone-edition">Sandstone edition</a>
                    </li>
                </ul>
                <br />

                <p>
                    Follow updates and news:
                    <br />
                    <a
                        href="https://twitter.com/sandstone_php"
                        class="twitter-follow-button"
                        data-size="large"
                        data-show-count="false"
                    >Follow @sandstone_php</a>
                    <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
                </p>
                <br />

                <p>
                    Find me here:
                    <br />
                    <a href="https://github.com/alcalyn">
                        <i class="fa fa-github fa-lg" aria-hidden="true"></i>
                        alcalyn
                    </a>
                    -
                    <a href="https://twitter.com/alcalyn_">
                        <i class="fa fa-twitter fa-lg" aria-hidden="true"></i>
                        alcalyn_
                    </a>
                </p>
            </div>
            <div class="col-md-3 text-center">
                <div class='jekyll-twitter-plugin'><a class="twitter-timeline" data-width="400" data-tweet-limit="2" href="https://twitter.com/sandstone_php?ref_src=twsrc%5Etfw">Tweets by sandstone_php</a>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
            </div>
        </div>
    </div>
</footer>


        <script async defer src="https://buttons.github.io/buttons.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="/sandstone/js/prism.js"></script>
    </body>
</html>
